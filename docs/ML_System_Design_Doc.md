# ML System Design Doc
## Дизайн ML системы - Система мониторинга пользовательских реакций на контент MVP 1

### 1. Цели и предпосылки 
#### 1.1. Зачем идем в разработку продукта?  

- **Бизнес-цель**: Автоматизировать мониторинг пользовательских реакций на контент (посты, рекламу, новости) в социальной сети для оперативного выявления негатива, улучшения модерации и повышения вовлеченности аудитории. Текущий процесс ручной модерации неэффективен, так как ежедневно поступает до 500 000 комментариев, что приводит к высоким затратам, задержкам и рискам штрафов от РКН.
- **Почему станет лучше, чем сейчас, от использования ML**:
  - **Скорость**: Автоматическая классификация тональности в реальном времени против выборочного ручного анализа.
  - **Масштабируемость**: Система способна обрабатывать до 1 млн комментариев в день.
  - **Объективность**: Исключение субъективности модераторов.
  - **Экономия**: Снижение затрат на ручную модерацию.
  - **Соответствие требованиям РКН**: Быстрое выявление неприемлемого контента.  
- **Что будем считать успехом итерации с точки зрения бизнеса**:
  - Снижение времени модерации на 80% по сравнению с текущим процессом.
  - Точность классификации тональности ≥ 85% (F1-score).
  - Снижение жалоб на модерацию на 50%.
  - Отсутствие критических ошибок в работе системы.
  - Модель бизнес процессов до разработки [см.](https://github.com/fearandloath1ng/system_design_project/blob/main/diagrams/bpmn_before.png)
  - Модель бизнес процессов после разработки [см.](https://github.com/fearandloath1ng/system_design_project/blob/main/diagrams/bpmn_after.png)
 
#### 1.2. Бизнес-требования и ограничения  

- **Бизнес-требования**:
  - Обработка до 500 000 комментариев в день.
  - Классификация тональности (негативная, нейтральная, позитивная) с точностью ≥ 85%.
  - Интеграция с API социальной сети.
  - Генерация отчетов о тональности в реальном времени.
  - Ссылки на детальные документы: [Требования к продукту](https://github.com/fearandloath1ng/system_design_project/blob/main/docs/requirements.md).
- **Бизнес-ограничения**:
  - Ограниченный бюджет.
  - Поддержка русского языка с учетом культурных особенностей.
  - Срок разработки MVP: 3 месяца.
- **Ожидания от итерации**:
  - Реализация базовой классификации тональности.
  - Интеграция с одним типом контента.
  - Минимальный дашборд для модераторов.
- **Бизнес-процесс пилота**:
  - Система получает комментарии через API социальной сети.
  - Автоматически классифицирует их и флагирует негативные для проверки модераторами.
  - Модераторы используют дашборд для просмотра результатов и подтверждения решений.
- **Критерии успешного пилота и пути развития**:
  - **Успех**:
    - F1-score ≥ 85% на выборке 10 000 комментариев.
    - Обработка 10 000 комментариев за 1 час.
    - Положительная обратная связь от модераторов (≥ 80% удовлетворенности).
  - **Развитие**:
    - Поддержка других типов контента (реклама, новости).
    - Расширенная аналитика (тренды, корреляции).
    - Автоматическое дообучение модели.

#### 1.3. Что входит в скоуп проекта/итерации, что не входит

- **Входит**:
  - Классификация тональности комментариев (негативная, нейтральная, позитивная).
  - Интеграция с API социальной сети для получения комментариев.
  - Базовый дашборд с распределением тональности (React + Tailwind CSS).
  - Хранение данных в облачной базе данных (PostgreSQL).
- **Не входит**:
  - Поддержка других языков.
  - Расширенная аналитика (тренды, корреляции).
  - Автоматическое дообучение модели (online learning).
- **Качество кода и воспроизводимость**:
  - Код модели и пайплайна размещен в репозитории GitHub с документацией.
  - Использование Docker для воспроизводимости окружения.
  - Юнит-тесты для preprocessing и API-методов.
- **Технический долг** :
  - Оптимизация модели для пиковых нагрузок.
  - Поддержка многоязычной классификации.
  - Интеграция с другими типами контента.

#### 1.4. Предпосылки решения
- **Предпосылки**:
  - **Данные**: Исторические комментарии (≥ 100 000) с разметкой тональности (негативная, нейтральная, позитивная).
  - **Горизонт прогноза**: Реальное время (классификация каждого комментария по мере поступления).
  - **Гранулярность модели**: Классификация на уровне отдельного комментария.
  - **Блоки данных**:
    - Текст комментариев и метаданные (автор, время, пост).
    - Контекст поста (опционально, для повышения качества).
  - **Обоснование**: Бизнес требует оперативного выявления негатива, что возможно только при обработке комментариев в реальном времени с использованием текстовых данных и их метаданных.


### 2. Методология
#### 2.1. Постановка задачи

- **Тип задачи**: Многоклассовая классификация текста (негативная, нейтральная, позитивная тональность).
- **Подход**: Использование трансформеров (RuBERT) для классификации текста на русском языке.

#### 2.2. Блок-схема решения

- **Бейзлайн и MVP** [см.](https://github.com/fearandloath1ng/system_design_project/blob/main/diagrams/product_scheme.png):
  - **Сбор данных**: Получение комментариев через API социальной сети.
  - **Предобработка**: Очистка текста, токенизация, удаление стоп-слов.
  - **Обучение модели**: RuBERT для классификации тональности.
  - **Инференс**: Классификация в реальном времени.
  - **Хранение**: Сохранение результатов в PostgreSQL.
  - **Визуализация**: Дашборд для модераторов.
  - **Уведомления**: Отправка флагов о негативных комментариях.
- **Примечание**: Бейзлайн использует предобученную модель RuBERT без дообучения, MVP включает дообучение на размеченных данных.

#### 2.3. Этапы решения задачи 

**Этап 1: Подготовка данных**

- **Данные и сущности**:

| Название данных | Есть ли данные в компании | Требуемый ресурс | Проверено ли качество данных |
|-----------------|--------------------------|------------------|-----------------------------|
| Комментарии     | Соцсеть: API Comments    | Data Engineer    | Нет                         |
| Разметка тональности | Нет                     | Data Scientist   | Нет                         |
| Метаданные постов | Соцсеть: API Posts     | Data Engineer    | Нет                         |

- **Результат этапа**:
  - Витрина данных в PostgreSQL с комментариями и метаданными.
  - Размеченный датасет (≥ 100 000 комментариев).
- **Техника (бейзлайн)**:
  - Сбор данных через API.
  - Ручная разметка подвыборки (10 000 комментариев).
- **Техника (MVP)**:
  - Сбор данных через API.
  - Разметка с использованием активного обучения (модераторы + модель).
- **Риски**:
  - Низкое качество разметки.
    - **Решение**: Двойная разметка и проверка согласованности (Cohen’s Kappa ≥ 0.8).

**Этап 2: Подготовка прогнозных моделей**

- **Формирование выборки**:
  - **Бейзлайн**: 10 000 размеченных комментариев (80% train, 10% val, 10% test).
  - **MVP**: 100 000 размеченных комментариев (80% train, 10% val, 10% test).
- **Горизонт и гранулярность**:
  - Реальное время, классификация на уровне комментария.
- **Целевая переменная**:
  - Тональность (негативная, нейтральная, позитивная).
- **Метрики качества**:
  - **Бейзлайн**: Accuracy ≥ 70%.
  - **MVP**: F1-score ≥ 85%, Precision ≥ 90% для класса "негатив".
  - **Связь с бизнесом**: Высокий Precision для "негатив" минимизирует ложные срабатывания, снижая нагрузку на модераторов.
- **Техника**:
  - **Feature engineering**: Токенизация текста, эмбеддинги RuBERT.
  - **Алгоритм**: RuBERT с дообучением на размеченных данных.
  - **Кросс-валидация**: 5-fold cross-validation.
- **Результат этапа**:
  - Обученная модель, готовая к инференсу.
- **Риски**:
  - Сарказм и культурные особенности.
    - **Решение**: Использование контекста постов и дообучение на разнообразных данных.

**Этап 3: Интеграция бизнес-правил**

- **Техника**:
  - Правила для флагирования негативных комментариев (например, если вероятность негатива > 0.7).
- **Результат этапа**:
  - Настроенные пороги для уведомлений модераторов.
- **Риски**:
  - Ложные срабатывания.
    - **Решение**: Бизнес-проверка на выборке модераторами.

**Этап 4: Подготовка инференса**

- **Техника**:
  - Развертывание модели на AWS SageMaker (GPU).
  - Интеграция с API для обработки комментариев.
- **Результат этапа**:
  - Рабочий инференс с latency ≤ 100 мс.
- **Риски**:
  - Высокая нагрузка.
    - **Решение**: Auto Scaling на AWS.
### 3. Подготовка пилота  

#### 3.1. Способ оценки пилота 

- Сравнение автоматической классификации с ручной разметкой на 10 000 комментариев.
- A/B-тестирование: контрольная группа (ручная модерация) vs. экспериментальная (автоматическая классификация).
- Сбор отзывов модераторов.

#### 3.2. Что считаем успешным пилотом

- F1-score ≥ 85% для всех классов.
- Обработка 10 000 комментариев за 1 час.
- Удовлетворенность модераторов ≥ 80%.

#### 3.3. Подготовка пилота 

- **Вычислительная сложность**:
  - Бейзлайн: тестирование на CPU (EC2 t3.medium).
  - MVP: использование GPU (SageMaker ml.g4dn.xlarge).
- **Ограничения**:
  - Оценка нагрузки на бейзлайне (10 000 комментариев).
  - Ограничение по latency (≤ 100 мс).

### 4. Внедрение


#### 4.1. Архитектура решения 

- **Блок-схема** [см.](https://github.com/fearandloath1ng/system_design_project/blob/main/diagrams/architecture.png):
  - **API Gateway**: Принимает комментарии.
  - **Preprocessing Service**: Очистка и токенизация.
  - **ML Model Service**: Классификация (RuBERT).
  - **Database**: PostgreSQL (результаты) + S3 (логи).
  - **Notification Service**: Уведомления модераторам.
  - **Dashboard**: React + Tailwind CSS.
- **Методы API**:
  - POST /comments: отправка комментария на классификацию.
  - GET /reports: получение отчета по тональности.
- **ER-диаграмма решения** [см.](https://github.com/fearandloath1ng/system_design_project/blob/main/diagrams/er_diagram.png).
- **Поведенческая UML-диаграмма** [см.](https://github.com/fearandloath1ng/system_design_project/blob/main/diagrams/uml_sequence.png).

#### 4.2. Описание инфраструктуры и масштабируемости

- **Инфраструктура**: AWS (EC2, RDS, S3, SageMaker).
- **Почему выбрана**:
  - Эластичность: Auto Scaling для пиковых нагрузок.
  - Надежность: RDS и S3 с высокой доступностью.
- **Плюсы**:
  - Гибкость в масштабировании.
  - Поддержка GPU.
- **Минусы**:
  - Зависимость от AWS.
- **Альтернативы**: GCP, Azure (отклонены из-за меньшей гибкости в настройке GPU).

#### 4.3. Требования к работе системы 

- **SLA**: 99.9% доступности.
- **RPS**: 6 000 запросов/сек.
- **Latency**: ≤ 100 мс на комментарий.

#### 4.4. Безопасность системы

- **Уязвимости**:
  - Атаки на API (DDoS).
    - **Решение**: AWS WAF.
- **Риски**:
  - Утечка данных.
    - **Решение**: Шифрование данных (AWS KMS).

#### 4.5. Безопасность данных 

- Анонимизация данных пользователей.
- Соответствие GDPR и российскому законодательству.

#### 4.6. Издержки 

- **Оценка**:
  - EC2 (t3.medium): ~$30/мес.
  - SageMaker (ml.g4dn.xlarge): ~$500/мес.
  - RDS (db.t3.medium): ~$100/мес.
  - S3: ~$50/мес.
  - Итого: ~$680/мес.

#### 4.7. Integration points

- **API Gateway → Preprocessing**: REST POST /preprocess.
- **Preprocessing → ML Model**: REST POST /predict.
- **ML Model → Database**: SQL INSERT.
- **Database → Dashboard**: REST GET /reports.

#### 4.8. Риски 

- **Сбой инфраструктуры**:
  - **Решение**: Мультизональное развертывание.
- **Устаревание модели**:
  - **Решение**: Дообучение раз в квартал.
- **Юридические ограничения**:
  - **Решение**: Анонимизация данных.
